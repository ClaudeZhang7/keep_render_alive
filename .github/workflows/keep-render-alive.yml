name: Keep Render Alive

on:
  schedule:
    - cron: "*/6 * * * *"
    - cron: "0 12 * * *"
  workflow_dispatch: {}

concurrency:
  group: keep-render-alive
  cancel-in-progress: true

jobs:
  keep-alive:
    # Evite de lancer keep-alive en même temps que le daily-stats
    if: github.event_name != 'schedule' || github.event.schedule != '0 12 * * *'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Ping endpoints (3 retries max, then continue)
        shell: bash
        run: |
          set +e

          HEALTH_URLS=(
            "https://smart-garden-002v.onrender.com/"
            "https://everything-z98m.onrender.com/health/"
            "https://pdfxpert-api.onrender.com/health/"
            "https://tokload-api-qx32.onrender.com/health/"
            "https://labubu-bot-3v9p.onrender.com/"
          )

          ping_once () {
            local URL="$1"
            curl -L --silent --show-error \
              --connect-timeout 10 --max-time 25 \
              -o /dev/null -w "HTTP=%{http_code} time=%{time_total}s\n" \
              "$URL"
          }

          for URL in "${HEALTH_URLS[@]}"; do
            echo "---- $URL"
            success=0

            for i in 1 2 3; do
              out="$(ping_once "$URL")"
              echo "$out"
              code="$(echo "$out" | sed -n 's/.*HTTP=\([0-9]\+\).*/\1/p')"

              # Réponse reçue = code HTTP != 000 (000 = timeout / pas de réponse)
              if [ -n "$code" ] && [ "$code" != "000" ]; then
                success=1
                break
              fi

              echo "retry in 10s ($i/3)"
              sleep 10
            done

            if [ "$success" -ne 1 ]; then
              echo "⚠ Impossible de joindre $URL après 3 tentatives (on continue)"
            fi
          done

  daily-stats:
    if: github.event_name == 'schedule' && github.event.schedule == '0 12 * * *'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Call /stats once
        run: |
          URL="https://everything-z98m.onrender.com/stats/"
          echo "Calling $URL"
          curl -L --fail --silent --show-error --max-time 60 "$URL" > /dev/null
          echo "Done"
