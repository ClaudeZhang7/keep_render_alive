name: Keep Render Alive

on:
  schedule:
    - cron: "*/6 * * * *"   # ping health
    - cron: "0 12 * * *"    # /stats 1×/jour (12:00 UTC)
  workflow_dispatch: {}

concurrency:
  group: keep-render-alive
  cancel-in-progress: true

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    steps:
      - name: Ping health endpoints (ignore failures)
        run: |
          HEALTH_URLS=(
            "https://everything-z98m.onrender.com/health/"
            "https://labubu-bot-3v9p.onrender.com"
            "https://pdfxpert-api.onrender.com/health/"
            "https://tokload-api-qx32.onrender.com/health/"
            "https://tokload-api-qx32.onrender.com/seo/"
            "https://smart-garden-002v.onrender.com/"
          )

          for URL in "${HEALTH_URLS[@]}"; do
            echo "---- $URL"
            success=0

            for i in 1 2 3; do
              # pas de --fail : n'importe quelle réponse réveille Render
              if curl --silent --show-error --max-time 90 "$URL" > /dev/null; then
                echo "OK (réponse reçue)"
                success=1
                break
              fi
              echo "retry in 10s ($i/3)"
              sleep 10
            done

            if [ "$success" -ne 1 ]; then
              echo "⚠ Impossible de joindre $URL après 3 tentatives (on ignore et on continue)"
            fi
          done

  daily-stats:
    if: github.event_name == 'schedule' && github.event.schedule == '0 12 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Call /stats once (no retries)
        run: |
          URL="https://everything-z98m.onrender.com/stats/"
          echo "Calling $URL (single shot)"
          curl --fail --silent --show-error --max-time 120 "$URL" > /dev/null
          echo "Done"
