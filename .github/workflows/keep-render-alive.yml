name: Keep Render Alive

on:
  schedule:
    - cron: "*/6 * * * *"   # ping health
    - cron: "0 12 * * *"    # /stats 1×/jour (12:00 UTC)
  workflow_dispatch: {}

# Empêche deux runs de se marcher dessus
concurrency:
  group: keep-render-alive
  cancel-in-progress: true

jobs:
  keep-alive:
    # Tourne pour tous les crons + lancement manuel
    runs-on: ubuntu-latest
    steps:
      - name: Ping health endpoints (3 tentatives avec retries)
        run: |
          HEALTH_URLS=(
            "https://everything-z98m.onrender.com/health/"
            "https://labubu-bot-3v9p.onrender.com"
            "https://pdfxpert-api.onrender.com/health/"
            "https://tokload-api-qx32.onrender.com/health/"
            "https://tokload-api-qx32.onrender.com/seo/"
            "https://smart-garden-002v.onrender.com/"
          )

          failed=0

          for URL in "${HEALTH_URLS[@]}"; do
            echo "---- $URL"
            success=0

            for i in 1 2 3; do
              if curl --fail --silent --show-error --max-time 90 "$URL" > /dev/null; then
                echo "OK"
                success=1
                break
              fi
              echo "retry in 10s ($i/3)"
              sleep 10
            done

            if [ "$success" -ne 1 ]; then
              echo "Échec après 3 tentatives pour $URL"
              failed=1
            fi
          done

          if [ "$failed" -ne 0 ]; then
            echo "Au moins un endpoint n'a pas répondu correctement."
            exit 1
          fi

  daily-stats:
    # Ne tourne QUE sur le cron "0 12 * * *"
    if: github.event_name == 'schedule' && github.event.schedule == '0 12 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Call /stats once (no retries)
        run: |
          URL="https://everything-z98m.onrender.com/stats/"
          echo "Calling $URL (single shot)"
          curl --fail --silent --show-error --max-time 120 "$URL" > /dev/null
          echo "Done"
